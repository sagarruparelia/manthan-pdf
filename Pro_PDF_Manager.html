<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Manager | Manthan Ruparelia & Associates</title>
    <script src="lib/pdf-lib.min.js"></script>
    <script src="lib/Sortable.min.js"></script>
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --success: #16a34a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .header { border-bottom: 2px solid #f1f5f9; margin-bottom: 20px; padding-bottom: 15px; }
        .branding { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .ca-logo { height: 60px; width: auto; }
        .brand-text { display: flex; flex-direction: column; }
        .firm-name { font-size: 24px; font-weight: 700; color: #1e40af; margin: 0; }
        .firm-subtitle { font-size: 14px; font-weight: 600; color: #16a34a; margin: 0; letter-spacing: 1px; }
        
        /* Settings Section */
        .settings-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .option-item { display: flex; align-items: center; gap: 10px; font-weight: 500; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; margin-top: 5px; }

        /* File List Styles */
        #sortableFileList { list-style: none; padding: 0; margin: 20px 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .file-item { display: flex; align-items: center; padding: 12px 15px; background: white; border-bottom: 1px solid #e2e8f0; }
        .file-item:last-child { border-bottom: none; }
        .file-item.ghost { opacity: 0.4; background: #dbeafe; }
        .drag-handle { cursor: grab; color: #94a3b8; margin-right: 15px; font-size: 20px; }
        .file-name { flex-grow: 1; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .remove-btn { color: #ef4444; cursor: pointer; font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .remove-btn:hover { background: #fee2e2; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 14px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-gray { background: var(--secondary); color: white; }
        .btn-green { background: var(--success); color: white; display: none; }
        .btn:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="branding">
            <img class="ca-logo" src="ca-logo.jpg" alt="ICAI Logo">
            <div class="brand-text">
                <h1 class="firm-name">Manthan Ruparelia & Associates</h1>
                <p class="firm-subtitle">CHARTERED ACCOUNTANTS</p>
            </div>
        </div>
        <p style="margin: 0; color: #64748b;">PDF Merge & Sequence Manager - Drag files to reorder, add watermarks, and export to Excel.</p>
    </div>

    <div class="settings-box">
        <div>
            <div class="option-item"><input type="checkbox" id="pageNumberToggle" checked> <span>Auto Page Numbers</span></div>
            <div class="option-item"><input type="checkbox" id="watermarkToggle"> <span>Add Watermark</span></div>
        </div>
        <div>
            <label style="font-size: 13px; color: #64748b;">Watermark Text:</label>
            <input type="text" id="watermarkText" placeholder="Example: CONFIDENTIAL">
        </div>
    </div>

    <div class="btn-group">
        <input type="file" id="pdfInput" accept="application/pdf" multiple style="display:none">
        <button class="btn btn-gray" onclick="document.getElementById('pdfInput').click()">+ Add PDF Files</button>
        <button class="btn btn-gray" style="background:#dc2626" onclick="clearAll()">Clear All</button>
        <button class="btn btn-blue" id="processBtn">Merge & Generate Index</button>
    </div>

    <ul id="sortableFileList">
        </ul>

    <div id="status" style="margin: 15px 0; font-weight: bold; color: var(--primary);"></div>

    <div class="btn-group">
        <button class="btn btn-green" id="downloadPdf">Download Merged PDF</button>
        <button class="btn btn-green" id="downloadExcel" style="background:#ea580c">Download Excel Index</button>
    </div>
</div>

<script>
    const { PDFDocument, rgb, StandardFonts, degrees } = PDFLib;
    let fileStore = []; // Array to store actual File objects
    let finalPdfBytes = null;
    let indexData = [];

    // Initialize SortableJS
    const listElement = document.getElementById('sortableFileList');
    const sortable = new Sortable(listElement, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'ghost'
    });

    // Handle File Selection
    document.getElementById('pdfInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const id = "id_" + Math.random().toString(36).substr(2, 9);
            fileStore.push({ id, file });
            addFileToUI(id, file.name);
        });
        e.target.value = ""; // Reset
    });

    function addFileToUI(id, name) {
        const li = document.createElement('li');
        li.className = 'file-item';
        li.setAttribute('data-id', id);
        li.innerHTML = `
            <span class="drag-handle">?</span>
            <span class="file-name">${name}</span>
            <span class="remove-btn" onclick="removeFile('${id}')">Remove</span>
        `;
        listElement.appendChild(li);
    }

    function removeFile(id) {
        fileStore = fileStore.filter(f => f.id !== id);
        const el = document.querySelector(`[data-id="${id}"]`);
        if (el) el.remove();
    }

    function clearAll() {
        fileStore = [];
        listElement.innerHTML = "";
        toggleResults(false);
    }

    function toggleResults(show) {
        const display = show ? 'block' : 'none';
        document.getElementById('downloadPdf').style.display = display;
        document.getElementById('downloadExcel').style.display = display;
    }

    // MAIN MERGE PROCESS
    document.getElementById('processBtn').addEventListener('click', async () => {
        // Get the order from the UI list
        const order = Array.from(listElement.children).map(li => li.getAttribute('data-id'));
        if (order.length === 0) return alert("Please add some files first!");

        const status = document.getElementById('status');
        status.innerText = "Processing... please wait.";

        const mergedPdf = await PDFDocument.create();
        const addNum = document.getElementById('pageNumberToggle').checked;
        const addWM = document.getElementById('watermarkToggle').checked;
        const wmText = document.getElementById('watermarkText').value || "CONFIDENTIAL";

        indexData = [];
        let globalPage = 1;

        // Loop through files in the DRAGGED order
        for (let i = 0; i < order.length; i++) {
            const id = order[i];
            const fileObj = fileStore.find(f => f.id === id).file;
            
            const arrayBuffer = await fileObj.arrayBuffer();
            const pdf = await PDFDocument.load(arrayBuffer);
            const pageCount = pdf.getPageCount();

            const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
            copiedPages.forEach(p => mergedPdf.addPage(p));

            indexData.push({
                sn: i + 1,
                name: fileObj.name,
                start: globalPage,
                end: globalPage + pageCount - 1,
                total: pageCount
            });
            globalPage += pageCount;
        }

        // Apply Global Page Numbers and Watermarks
        const pages = mergedPdf.getPages();
        const font = await mergedPdf.embedFont(StandardFonts.Helvetica);

        pages.forEach((page, idx) => {
            const { width, height } = page.getSize();
            if (addWM) {
                page.drawText(wmText, {
                    x: width / 5, y: height / 3, size: 55, font,
                    color: rgb(0.8, 0.8, 0.8), opacity: 0.35, rotate: degrees(45)
                });
            }
            if (addNum) {
                page.drawText(`Page ${idx + 1} of ${pages.length}`, {
                    x: width / 2 - 30, y: 20, size: 10, font, color: rgb(0, 0, 0)
                });
            }
        });

        finalPdfBytes = await mergedPdf.save();
        status.innerText = "Merge Successful!";
        toggleResults(true);
    });

    // EXPORT DOWNLOADS
    document.getElementById('downloadPdf').onclick = () => {
        const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });
        saveFile(blob, "Merged_Document.pdf");
    };

    document.getElementById('downloadExcel').onclick = () => {
        let csv = "S.No,File Name,Start Page,End Page,Total Pages\n";
        indexData.forEach(d => csv += `${d.sn},"${d.name}",${d.start},${d.end},${d.total}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        saveFile(blob, "PDF_Index.csv");
    };

    function saveFile(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
    }
</script>
</body>
</html>